<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Loandr</title>

    <!-- Security Headers -->
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="SAMEORIGIN">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">

    <link rel="stylesheet" href="styles.css">
    <style>
        :root {
            --navy-blue: #1e3a5f;
            --navy-dark: #152a45;
            --navy-light: #2c4f7c;
            --green-primary: #2e7d32;
            --green-light: #4caf50;
            --green-dark: #1b5e20;
            --white: #ffffff;
            --off-white: #f8f9fa;
            --light-gray: #e9ecef;
            --medium-gray: #6c757d;
            --dark-gray: #343a40;
            --text-dark: #212529;
            --text-muted: #6c757d;
        }

        /* Dark Mode Theme */
        [data-theme="dark"] {
            --navy-blue: #5d8cc9;
            --navy-dark: #4a7ab8;
            --navy-light: #7ba3d6;
            --green-primary: #4caf50;
            --green-light: #81c784;
            --green-dark: #388e3c;
            --white: #1a1a2e;
            --off-white: #16213e;
            --light-gray: #2a2a4a;
            --medium-gray: #9e9e9e;
            --dark-gray: #e0e0e0;
            --text-dark: #e8e8e8;
            --text-muted: #a0a0a0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--off-white);
        }

        /* Login Screen */
        .admin-login-wrapper {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .admin-login-card {
            background: var(--white);
            border-radius: 24px;
            padding: 50px;
            width: 100%;
            max-width: 420px;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.15);
            border: 1px solid var(--light-gray);
        }

        .admin-login-header {
            text-align: center;
            margin-bottom: 35px;
        }

        .admin-login-header .icon {
            font-size: 3.5rem;
            margin-bottom: 20px;
        }

        .admin-login-header h1 {
            color: var(--navy-blue);
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .admin-login-header p {
            color: var(--text-muted);
            font-size: 0.95rem;
        }

        .admin-form-group {
            margin-bottom: 22px;
        }

        .admin-form-group label {
            display: block;
            color: var(--dark-gray);
            margin-bottom: 8px;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .admin-form-group input {
            width: 100%;
            padding: 15px 18px;
            background: var(--white);
            border: 1px solid var(--light-gray);
            border-radius: 12px;
            color: var(--text-dark);
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .admin-form-group input:focus {
            outline: none;
            border-color: var(--navy-blue);
            background: var(--white);
            box-shadow: 0 0 0 4px rgba(30, 58, 95, 0.1);
        }

        .admin-form-group input::placeholder {
            color: var(--text-muted);
        }

        .admin-login-btn {
            width: 100%;
            padding: 16px;
            background: var(--navy-blue);
            border: none;
            border-radius: 12px;
            color: var(--white);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .admin-login-btn:hover {
            background: var(--navy-dark);
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(30, 58, 95, 0.3);
        }

        .admin-login-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .admin-error {
            background: rgba(211, 47, 47, 0.1);
            border: 1px solid rgba(211, 47, 47, 0.3);
            color: #d32f2f;
            padding: 14px 18px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 0.9rem;
            display: none;
        }

        .admin-error.show {
            display: block;
        }

        .back-link {
            display: block;
            text-align: center;
            margin-top: 25px;
            color: var(--text-muted);
            text-decoration: none;
            font-size: 0.9rem;
            transition: color 0.3s ease;
        }

        .back-link:hover {
            color: var(--navy-blue);
        }

        /* Dashboard */
        .admin-dashboard {
            display: none;
            min-height: 100vh;
            padding: 30px;
        }

        .admin-dashboard.active {
            display: block;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 35px;
            padding-bottom: 25px;
            border-bottom: 1px solid var(--light-gray);
        }

        .dashboard-header h1 {
            color: var(--navy-blue);
            font-size: 1.8rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .dashboard-header h1 span {
            font-size: 2rem;
        }

        .dashboard-nav {
            display: flex;
            gap: 12px;
        }

        .nav-btn {
            padding: 12px 24px;
            background: var(--white);
            border: 1px solid var(--light-gray);
            border-radius: 10px;
            color: var(--dark-gray);
            text-decoration: none;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .nav-btn:hover {
            background: var(--off-white);
            color: var(--navy-blue);
            border-color: var(--navy-blue);
        }

        .nav-btn.danger {
            background: rgba(211, 47, 47, 0.1);
            border-color: rgba(211, 47, 47, 0.3);
            color: #d32f2f;
        }

        .nav-btn.danger:hover {
            background: rgba(211, 47, 47, 0.2);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 35px;
        }

        .stat-card {
            background: var(--white);
            border: 1px solid var(--light-gray);
            border-radius: 16px;
            padding: 28px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            border-color: var(--navy-light);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .stat-card .value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--navy-blue);
            margin-bottom: 8px;
        }

        .stat-card .label {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        /* Tab Navigation */
        .tab-nav {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 12px 24px;
            background: var(--white);
            border: 1px solid var(--light-gray);
            border-radius: 10px;
            color: var(--text-muted);
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tab-btn:hover {
            background: var(--off-white);
            color: var(--navy-blue);
        }

        .tab-btn.active {
            background: var(--navy-blue);
            border-color: var(--navy-blue);
            color: var(--white);
        }

        /* Content Panels */
        .content-panel {
            background: var(--white);
            border: 1px solid var(--light-gray);
            border-radius: 16px;
            padding: 30px;
            display: none;
        }

        .content-panel.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .content-panel h2 {
            color: var(--navy-blue);
            font-size: 1.3rem;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--light-gray);
        }

        /* Data Table */
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th,
        .data-table td {
            padding: 14px 18px;
            text-align: left;
            border-bottom: 1px solid var(--light-gray);
        }

        .data-table th {
            background: var(--navy-blue);
            color: var(--white);
            font-weight: 500;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .data-table td {
            color: var(--text-dark);
            font-size: 0.95rem;
        }

        .data-table tr:hover td {
            background: var(--off-white);
        }

        .no-data {
            text-align: center;
            padding: 50px;
            color: var(--text-muted);
        }

        /* Action Buttons */
        .action-bar {
            display: flex;
            gap: 12px;
            margin-bottom: 25px;
        }

        .action-btn {
            padding: 12px 24px;
            border-radius: 10px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
        }

        .action-btn.primary {
            background: var(--green-primary);
            color: var(--white);
        }

        .action-btn.primary:hover {
            background: var(--green-dark);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(46, 125, 50, 0.3);
        }

        .action-btn.danger {
            background: rgba(211, 47, 47, 0.1);
            border: 1px solid rgba(211, 47, 47, 0.3);
            color: #d32f2f;
        }

        .action-btn.danger:hover {
            background: rgba(211, 47, 47, 0.2);
        }

        /* JSON Viewer */
        .json-viewer {
            background: var(--off-white);
            border: 1px solid var(--light-gray);
            border-radius: 12px;
            padding: 25px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.85rem;
            color: var(--green-dark);
            overflow: auto;
            max-height: 500px;
            white-space: pre-wrap;
            word-break: break-word;
        }

        /* User Cards */
        .user-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .user-card {
            background: var(--off-white);
            border: 1px solid var(--light-gray);
            border-radius: 12px;
            padding: 20px;
        }

        .user-card h3 {
            color: var(--navy-blue);
            font-size: 1.1rem;
            margin-bottom: 12px;
        }

        .user-card p {
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-bottom: 6px;
        }

        .user-card .email {
            color: var(--navy-blue);
        }

        .user-card .date {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 10px;
        }

        /* Server Status */
        .server-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.85rem;
            margin-left: 15px;
        }

        .server-badge.online {
            background: rgba(46, 125, 50, 0.15);
            color: var(--green-primary);
        }

        .server-badge.offline {
            background: rgba(255, 152, 0, 0.15);
            color: #f57c00;
        }

        .server-badge::before {
            content: '';
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .admin-dashboard {
                padding: 20px;
            }

            .dashboard-header {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }

            .dashboard-nav {
                justify-content: center;
            }

            .action-bar {
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <div class="mountain-layer-3"></div>
    <div class="mountain-layer-2"></div>
    <div class="mountain-front"></div>

    <!-- Login Screen -->
    <div class="admin-login-wrapper" id="loginScreen">
        <div class="admin-login-card">
            <div class="admin-login-header">
                <div class="icon">üîê</div>
                <h1>Admin Access</h1>
                <p>Enter the admin password to continue</p>
            </div>

            <div id="loginError" class="admin-error"></div>

            <form id="adminLoginForm">
                <div class="admin-form-group">
                    <label for="adminPassword">Admin Password</label>
                    <div style="position: relative;">
                        <input type="password" id="adminPassword" placeholder="Enter admin password" required autofocus>
                        <button type="button" id="togglePassword" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; color: #888; cursor: pointer; font-size: 0.9rem;">Show</button>
                    </div>
                </div>
                <button type="submit" class="admin-login-btn" id="loginBtn">Access Dashboard</button>
            </form>

            <a href="index.html" class="back-link">Back to Loan Comparison Tool</a>
        </div>
    </div>

    <!-- Dashboard -->
    <div class="admin-dashboard" id="dashboard">
        <div class="dashboard-header">
            <h1>
                <span style="display: inline-flex; align-items: center; margin-right: 8px;">
                    <svg width="32" height="32" viewBox="0 0 44 44" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <!-- L shape that forms into checkmark -->
                        <path d="M10 8 L10 32 L24 32" stroke="var(--navy-blue)" stroke-width="4" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                        <!-- Checkmark extending from L -->
                        <path d="M24 32 L28 28 L38 10" stroke="var(--green-primary)" stroke-width="4" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                    </svg>
                </span>
                Loan<span style="color: var(--green-primary); font-weight: 800;">dr</span> Admin
                <span id="serverBadge" class="server-badge offline">Checking...</span>
            </h1>
            <div class="dashboard-nav">
                <a href="index.html" class="nav-btn">Back to Tool</a>
                <button class="nav-btn danger" id="logoutBtn">Sign Out</button>
            </div>
        </div>

        <!-- Stats Overview -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="value" id="statUsers">0</div>
                <div class="label">Registered Users</div>
            </div>
            <div class="stat-card">
                <div class="value" id="statScenarios">0</div>
                <div class="label">Saved Scenarios</div>
            </div>
            <div class="stat-card">
                <div class="value" id="statSettings">0</div>
                <div class="label">Settings Profiles</div>
            </div>
            <div class="stat-card">
                <div class="value" id="statTitleCompanies">0</div>
                <div class="label">Title Fee Schedules</div>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="tab-nav">
            <button class="tab-btn active" data-tab="overview">Overview</button>
            <button class="tab-btn" data-tab="users">Users</button>
            <button class="tab-btn" data-tab="settings">Local Settings</button>
            <button class="tab-btn" data-tab="raw">Raw Data</button>
        </div>

        <!-- Overview Tab -->
        <div class="content-panel active" id="panel-overview">
            <h2>System Overview</h2>
            <div class="action-bar">
                <button class="action-btn primary" id="exportAllBtn">Export All Data</button>
                <button class="action-btn danger" id="clearLocalBtn">Clear Local Data</button>
            </div>
            <p style="color: #888; line-height: 1.6;">
                This dashboard provides an overview of all data stored by the Loan Comparison Tool.
                When the server is online, user data is stored securely on the server.
                Local settings and cached data are stored in the browser's localStorage.
            </p>
        </div>

        <!-- Users Tab -->
        <div class="content-panel" id="panel-users">
            <h2>Registered Users</h2>
            <div id="usersContent" class="user-grid">
                <p class="no-data">Loading users...</p>
            </div>
        </div>

        <!-- Settings Tab -->
        <div class="content-panel" id="panel-settings">
            <h2>Local Settings Data</h2>
            <table class="data-table" id="settingsTable">
                <thead>
                    <tr>
                        <th>Setting</th>
                        <th>Value</th>
                    </tr>
                </thead>
                <tbody id="settingsBody">
                    <!-- Populated by JS -->
                </tbody>
            </table>
        </div>

        <!-- Raw Data Tab -->
        <div class="content-panel" id="panel-raw">
            <h2>Raw JSON Data</h2>
            <div class="action-bar">
                <button class="action-btn primary" id="copyRawBtn">Copy to Clipboard</button>
            </div>
            <div class="json-viewer" id="rawData">Loading...</div>
        </div>
    </div>

    <script src="api.js"></script>
    <script>
        // Security utilities
        function escapeHtml(str) {
            if (str === null || str === undefined) return '';
            const div = document.createElement('div');
            div.textContent = String(str);
            return div.innerHTML;
        }

        function generateNonce() {
            const array = new Uint8Array(16);
            crypto.getRandomValues(array);
            return Array.from(array, byte => byte.toString(16).padStart(2, '0')).join('');
        }

        // Rate limiter
        const rateLimiter = {
            attempts: {},
            maxAttempts: 5,
            windowMs: 60000,
            check(key) {
                const now = Date.now();
                if (!this.attempts[key]) {
                    this.attempts[key] = { count: 1, firstAttempt: now };
                    return true;
                }
                const record = this.attempts[key];
                if (now - record.firstAttempt > this.windowMs) {
                    this.attempts[key] = { count: 1, firstAttempt: now };
                    return true;
                }
                if (record.count >= this.maxAttempts) {
                    return false;
                }
                record.count++;
                return true;
            },
            reset(key) {
                delete this.attempts[key];
            }
        };

        // Check authentication
        let serverOnline = false;
        let adminToken = null;

        function checkAuth() {
            const token = sessionStorage.getItem('adminToken');
            const tokenTime = parseInt(sessionStorage.getItem('adminTokenTime') || '0');
            const maxAge = 30 * 60 * 1000; // 30 minutes

            if (token && (Date.now() - tokenTime) < maxAge) {
                sessionStorage.setItem('adminTokenTime', Date.now().toString());
                showDashboard();
                return true;
            }

            sessionStorage.removeItem('adminToken');
            sessionStorage.removeItem('adminTokenTime');
            showLogin();
            return false;
        }

        function showLogin() {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('dashboard').classList.remove('active');
        }

        function showDashboard() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('dashboard').classList.add('active');
            loadDashboardData();
        }

        // Check server status
        async function checkServer() {
            const badge = document.getElementById('serverBadge');
            try {
                const status = await API.healthCheck();
                serverOnline = status.online;
                if (serverOnline) {
                    badge.textContent = 'Server Online';
                    badge.className = 'server-badge online';
                } else {
                    badge.textContent = 'Offline Mode';
                    badge.className = 'server-badge offline';
                }
            } catch {
                serverOnline = false;
                badge.textContent = 'Offline Mode';
                badge.className = 'server-badge offline';
            }
        }

        // Load dashboard data
        async function loadDashboardData() {
            await checkServer();

            // Load server stats if online
            if (serverOnline) {
                try {
                    const statsData = await API.getAdminStats();
                    document.getElementById('statUsers').textContent = statsData.stats.totalUsers || 0;
                    document.getElementById('statScenarios').textContent = statsData.stats.totalScenarios || 0;
                    document.getElementById('statSettings').textContent = statsData.stats.totalSettings || 0;
                } catch (error) {
                    console.warn('Could not load server stats:', error);
                }

                // Load users
                try {
                    const usersData = await API.getAdminUsers();
                    displayUsers(usersData.users || []);
                } catch (error) {
                    console.warn('Could not load users:', error);
                    document.getElementById('usersContent').innerHTML = '<p class="no-data">Could not load users from server</p>';
                }
            } else {
                document.getElementById('statUsers').textContent = '-';
                document.getElementById('statScenarios').textContent = '-';
                document.getElementById('statSettings').textContent = '-';
                document.getElementById('usersContent').innerHTML = '<p class="no-data">Server offline - user data not available</p>';
            }

            // Load local settings
            loadLocalSettings();
        }

        function displayUsers(users) {
            const container = document.getElementById('usersContent');
            if (!users || users.length === 0) {
                container.innerHTML = '<p class="no-data">No registered users</p>';
                return;
            }

            container.innerHTML = users.map(user => `
                <div class="user-card">
                    <h3>${escapeHtml(user.firstName)} ${escapeHtml(user.lastName)}</h3>
                    <p class="email">${escapeHtml(user.email)}</p>
                    <p>${escapeHtml(user.company || 'No company')}</p>
                    <p>${escapeHtml(user.phone || 'No phone')}</p>
                    ${user.nmls ? `<p>NMLS: ${escapeHtml(user.nmls)}</p>` : ''}
                    <p class="date">Joined: ${new Date(user.createdAt).toLocaleDateString()}</p>
                </div>
            `).join('');
        }

        function loadLocalSettings() {
            let settings;
            try {
                settings = JSON.parse(localStorage.getItem('loanComparisonSettings') || '{}');
            } catch {
                settings = {};
            }

            // Update title companies count
            document.getElementById('statTitleCompanies').textContent = settings.titleCompanies?.length || 0;

            // Populate settings table
            const tbody = document.getElementById('settingsBody');
            const rows = [];

            if (settings.loanOfficer) {
                rows.push(['Loan Officer Name', escapeHtml(settings.loanOfficer.name) || '-']);
                rows.push(['Loan Officer Company', escapeHtml(settings.loanOfficer.company) || '-']);
                rows.push(['Loan Officer Email', escapeHtml(settings.loanOfficer.email) || '-']);
            }

            if (settings.realtor) {
                rows.push(['Realtor Enabled', settings.realtor.enabled ? 'Yes' : 'No']);
                rows.push(['Realtor Name', escapeHtml(settings.realtor.name) || '-']);
            }

            if (settings.titleAgent) {
                rows.push(['Title Agent Enabled', settings.titleAgent.enabled ? 'Yes' : 'No']);
                rows.push(['Title Company', escapeHtml(settings.titleAgent.company) || '-']);
            }

            if (settings.titleCompanies && settings.titleCompanies.length > 0) {
                rows.push(['Title Fee Schedules', settings.titleCompanies.length + ' saved']);
            }

            if (rows.length === 0) {
                tbody.innerHTML = '<tr><td colspan="2" class="no-data">No local settings saved</td></tr>';
            } else {
                tbody.innerHTML = rows.map(([key, val]) => `
                    <tr><td>${key}</td><td>${val}</td></tr>
                `).join('');
            }

            // Update raw JSON
            document.getElementById('rawData').textContent = JSON.stringify(settings, null, 2);
        }

        // Login form
        document.getElementById('adminLoginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const errorEl = document.getElementById('loginError');
            errorEl.classList.remove('show');

            if (!rateLimiter.check('adminLogin')) {
                errorEl.textContent = 'Too many attempts. Please wait 1 minute.';
                errorEl.classList.add('show');
                return;
            }

            const password = document.getElementById('adminPassword').value;
            const btn = document.getElementById('loginBtn');
            btn.disabled = true;
            btn.textContent = 'Verifying...';

            try {
                // Try server login first
                await checkServer();
                if (serverOnline) {
                    const data = await API.adminLogin(password);
                    adminToken = data.token;
                    sessionStorage.setItem('adminToken', generateNonce());
                    sessionStorage.setItem('adminTokenTime', Date.now().toString());
                    rateLimiter.reset('adminLogin');
                    showDashboard();
                } else {
                    // Fallback to local validation
                    if (password === 'Ricky031100') {
                        sessionStorage.setItem('adminToken', generateNonce());
                        sessionStorage.setItem('adminTokenTime', Date.now().toString());
                        rateLimiter.reset('adminLogin');
                        showDashboard();
                    } else {
                        throw new Error('Invalid admin password');
                    }
                }
            } catch (error) {
                errorEl.textContent = error.message || 'Invalid admin password';
                errorEl.classList.add('show');
                btn.disabled = false;
                btn.textContent = 'Access Dashboard';
            }
        });

        // Tab switching
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.content-panel').forEach(p => p.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById('panel-' + btn.dataset.tab).classList.add('active');
            });
        });

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', () => {
            sessionStorage.removeItem('adminToken');
            sessionStorage.removeItem('adminTokenTime');
            showLogin();
        });

        // Export all data
        document.getElementById('exportAllBtn').addEventListener('click', () => {
            const settings = localStorage.getItem('loanComparisonSettings') || '{}';
            const blob = new Blob([settings], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'loan_comparison_export_' + new Date().toISOString().split('T')[0] + '.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        // Copy raw data
        document.getElementById('copyRawBtn').addEventListener('click', () => {
            const text = document.getElementById('rawData').textContent;
            navigator.clipboard.writeText(text).then(() => {
                const btn = document.getElementById('copyRawBtn');
                btn.textContent = 'Copied!';
                setTimeout(() => {
                    btn.textContent = 'Copy to Clipboard';
                }, 2000);
            });
        });

        // Clear local data
        document.getElementById('clearLocalBtn').addEventListener('click', () => {
            if (confirm('Clear all local settings? This cannot be undone.')) {
                if (confirm('This will delete loan officer info, realtor info, and title company settings. Continue?')) {
                    localStorage.removeItem('loanComparisonSettings');
                    loadLocalSettings();
                    alert('Local data cleared.');
                }
            }
        });

        // Toggle password visibility
        document.getElementById('togglePassword').addEventListener('click', () => {
            const passwordInput = document.getElementById('adminPassword');
            const toggleBtn = document.getElementById('togglePassword');
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleBtn.textContent = 'Hide';
            } else {
                passwordInput.type = 'password';
                toggleBtn.textContent = 'Show';
            }
        });

        // Initialize
        checkAuth();

        // Apply dark mode if saved
        const darkMode = localStorage.getItem('loanComparisonDarkMode');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        if (darkMode === 'true' || (darkMode === null && prefersDark)) {
            document.documentElement.setAttribute('data-theme', 'dark');
        }
    </script>
</body>
</html>
